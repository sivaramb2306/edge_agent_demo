FROM ubuntu:22.04

# Install build dependencies and runtime libraries
RUN apt-get update && apt-get install -y \
    g++ \
    make \
    cmake \
    git \
    libsnmp-dev \
    snmp \
    libcurl4-openssl-dev \
    libssl-dev \
    libgtest-dev \
    google-mock \
    rapidjson-dev \
    python3-pip \
    ninja-build \
    pkg-config \
    nlohmann-json3-dev \
    gdb \
    valgrind \
    vim \
    && pip3 install meson \
    && cd /usr/src/googletest && cmake . && make && make install \
    && rm -rf /var/lib/apt/lists/*

# Set working directory
WORKDIR /app

# Copy source code
COPY . .

# Clean any existing build artifacts
RUN rm -rf build pistache

# Build and install Pistache with debug symbols
RUN git clone https://github.com/pistacheio/pistache.git && \
    cd pistache && \
    meson setup build \
    -DPISTACHE_USE_SSL=true \
    --buildtype=debug && \
    meson compile -C build && \
    meson install -C build && \
    ldconfig

# Build the application with debug symbols and tests
RUN mkdir -p build && \
    cd build && \
    cmake -DCMAKE_BUILD_TYPE=Debug \
          -DBUILD_TESTS=ON \
          -DCMAKE_CXX_FLAGS="-g3 -O0" .. && \
    make

# Default command - run tests first then start the application
CMD ["sh", "-c", "./build/snmp_client_test && ./build/edge_agent"]
