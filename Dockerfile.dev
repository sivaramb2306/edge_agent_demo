FROM ubuntu:22.04

# Install build dependencies and runtime libraries
RUN apt-get update && apt-get install -y \
    g++ \
    make \
    cmake \
    git \
    pkg-config \
    && rm -rf /var/lib/apt/lists/*

RUN apt-get update && apt-get install -y \
    libsnmp-dev \
    libcurl4-openssl-dev \
    libssl-dev \
    nlohmann-json3-dev \
    snmp \
    snmp-mibs-downloader \
    && download-mibs \
    && rm -rf /var/lib/apt/lists/*

# Install GTest and GMock
RUN apt-get update && apt-get install -y \
    libgtest-dev \
    google-mock \
    && cd /usr/src/googletest \
    && cmake . \
    && cmake --build . -j$(nproc) \
    && cp -a lib/libg* /usr/lib/ \
    && cd googlemock \
    && cp -a include/gmock /usr/include/ \
    && cd ../googletest \
    && cp -a include/gtest /usr/include/ \
    && rm -rf /var/lib/apt/lists/*

# Install development tools
RUN apt-get update && apt-get install -y \
    gdb \
    valgrind \
    vim \
    && rm -rf /var/lib/apt/lists/*

RUN apt-get update && apt-get install -y \
    python3-pip \
    ninja-build \
    && pip3 install meson \
    && rm -rf /var/lib/apt/lists/*

WORKDIR /app
COPY . .

RUN git -c advice.detachedHead=false clone -q https://github.com/pistacheio/pistache.git /tmp/pistache

WORKDIR /tmp/pistache
RUN git -c advice.detachedHead=false checkout -q v0.4.26 \
    && meson setup build \
        --buildtype=debug \
        --prefix=/usr/local \
        -DPISTACHE_USE_SSL=true

WORKDIR /tmp/pistache/build
RUN meson compile \
    && meson install \
    && ldconfig

WORKDIR /app
RUN rm -rf /tmp/pistache build

# Copy MIBs to the correct location
COPY snmpd/powernet455.txt /usr/share/snmp/mibs/PowerNet-MIB.txt
COPY snmpd/mibs/* /usr/share/snmp/mibs/

# Set SNMP environment variables
ENV MIBS=+ALL
ENV MIBDIRS=/usr/share/snmp/mibs:/usr/share/snmp/mibs/ietf:/usr/share/snmp/mibs/iana:/usr/share/snmp/mibs/site
ENV SNMP_PERSISTENT_DIR=/var/lib/snmp

# Build the application with debug symbols and tests enabled
RUN mkdir -p /app/build && cd /app/build \
    && cmake -DCMAKE_BUILD_TYPE=Debug \
        -DBUILD_TESTS=ON \
        -DCMAKE_CXX_FLAGS="-g3 -O0" \
        .. \
    && make -j$(nproc)

WORKDIR /app/build

# Default command - show directory contents and run the server
CMD ["sh", "-c", "ls -la && pwd && ./rest_server"]
